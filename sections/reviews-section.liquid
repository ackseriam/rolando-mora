{% comment %}
  GoPure Style Reviews Section - Stylized Purple Design
  Refined for "Peek" Effect with Neighbors
{% endcomment %}

{{ 'section-gopure-reviews.css' | asset_url | stylesheet_tag }}

{%- style -%}
  #shopify-section-{{ section.id }} {
    --color-lavender-bg: {{ section.settings.bg_color }};
    --color-card-pink: {{ section.settings.card_bg_color }};
    --color-pill-purple: {{ section.settings.badge_bg_color }};
    --color-deep-purple: {{ section.settings.text_color }};
  }
{%- endstyle -%}

<div class="gopure-reviews-section section-{{ section.id }} bg-wisp" id="product-reviews">
  <div class="page-width-carousel text-center">
    
    {%- if section.settings.title != blank -%}
      <h2 class="section-title">{{ section.settings.title }}</h2>
    {%- endif -%}
    {%- if section.settings.subtitle != blank -%}
      <p class="section-subtitle">{{ section.settings.subtitle }}</p>
    {%- endif -%}

    <div class="reviews-carousel-container">
      
      <button class="nav-arrow nav-prev" id="PrevSlide-{{ section.id }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
      </button>
      <button class="nav-arrow nav-next" id="NextSlide-{{ section.id }}">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
      </button>

      <div class="reviews-track-wrapper">
        <div class="reviews-track" id="ReviewsTrack-{{ section.id }}" style="transform: translateX(0);">
          {%- for block in section.blocks -%}
            <div class="review-slide" {{ block.shopify_attributes }} data-index="{{ forloop.index0 }}">
              <div class="review-card">
                
                <div class="review-images-col">
                  <!-- Before Image -->
                  <div class="image-wrapper">
                    {%- if block.settings.image_before != blank -%}
                      {{ block.settings.image_before | image_url: width: 600 | image_tag: loading: 'lazy', class: 'review-img' }}
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg review-img' }}
                    {%- endif -%}
                    <span class="image-label-pill label-left">Before</span>
                  </div>

                  <!-- After Image -->
                  <div class="image-wrapper">
                    {%- if block.settings.image_after != blank -%}
                      {{ block.settings.image_after | image_url: width: 600 | image_tag: loading: 'lazy', class: 'review-img' }}
                    {%- else -%}
                      {{ 'product-2' | placeholder_svg_tag: 'placeholder-svg review-img' }}
                    {%- endif -%}
                    <span class="image-label-pill label-right">After {{ block.settings.duration }}</span>
                  </div>
                </div>

                <div class="review-content-col">
                  <div class="stars">★★★★★</div>
                  <blockquote class="review-quote">"{{ block.settings.quote }}"</blockquote>
                  
                  <div class="reviewer-info">
                     {%- if block.settings.author_image != blank -%}
                      {{ block.settings.author_image | image_url: width: 100 | image_tag: loading: 'lazy', class: 'reviewer-img' }}
                    {%- else -%}
                      <img src="https://ui-avatars.com/api/?name={{ block.settings.author_name | url_encode }}&background=e0d7ff&color=4834d4&size=100" alt="{{ block.settings.author_name }}" class="reviewer-img">
                    {%- endif -%}
                    
                    <div>
                        <div class="reviewer-name">{{ block.settings.author_name }}</div>
                        {%- if block.settings.concern != blank -%}
                            <div class="reviewer-meta">{{ block.settings.concern }}</div>
                        {%- endif -%}
                    </div>
                  </div>
                </div>

              </div>
            </div>
          {%- endfor -%}
        </div>
      </div>
    </div>

    <!-- Bottom Info -->
    <div class="bottom-area">
        <span class="disclaimer-pill">Consumer results, may vary</span>
        
        <div class="progress-track">
            <div class="progress-fill" id="ProgressBar-{{ section.id }}"></div>
        </div>

        {%- if section.settings.button_label != blank -%}
            <a href="{{ section.settings.button_link }}" class="see-all-link">
            {{ section.settings.button_label }} →
            </a>
        {%- endif -%}
    </div>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sectionId = '{{ section.id }}';
    const track = document.getElementById(`ReviewsTrack-${sectionId}`);
    if (!track) return;

    let slides = Array.from(document.querySelectorAll(`#ReviewsTrack-${sectionId} .review-slide`));
    const slideCount = slides.length;
    let currentIndex = 0; // The index in the data array, not visually

    const progressBar = document.getElementById(`ProgressBar-${sectionId}`);
    
    // Config
    const isMobile = window.matchMedia('(max-width: 767px)').matches;
    
    // Update Layout Function
    function render() {
        if (!track) return;
        
        // Ensure we know the slide width
        // We calculate translation to center the current index
        const trackWidth = track.parentElement.offsetWidth;
        const slideWidth = slides[0].offsetWidth; 
        
        // Calculate center offset
        const centerOffset = (trackWidth - slideWidth) / 2;
        
        // Translate to move the current slide to 0 (left edge), then add center offset
        // But slides are just in a flow.
        // We simply move the WHOLE TRACK so that the target slide is at the center.
        // Position of target slide relative to track start = index * slideWidth (roughly, if no gaps, but flex has gaps)
        
        // Better: use offsetLeft of the target slide
        const targetSlide = slides[currentIndex];
        const currentLeft = targetSlide.offsetLeft;
        
        const translateX = -(currentLeft - centerOffset);
        
        track.style.transform = `translateX(${translateX}px)`;
        
        // Update Classes
        slides.forEach((slide, i) => {
            if (i === currentIndex) {
                slide.classList.add('is-selected');
                slide.style.opacity = '1';
                slide.style.transform = 'scale(1)';
            } else {
                slide.classList.remove('is-selected');
                slide.style.opacity = '0.4';
                slide.style.transform = 'scale(0.9)';
            }
        });
        
        // Update Progress
        const percent = ((currentIndex + 1) / slideCount) * 100;
        if(progressBar) progressBar.style.width = `${percent}%`;
    }

    // Controls
    document.getElementById(`PrevSlide-${sectionId}`)?.addEventListener('click', () => {
        currentIndex = (currentIndex - 1 + slideCount) % slideCount;
        render();
    });
    
    document.getElementById(`NextSlide-${sectionId}`)?.addEventListener('click', () => {
        currentIndex = (currentIndex + 1) % slideCount;
        render();
    });

    window.addEventListener('resize', render);
    
    // Initial Render
    // Wait for layout
    setTimeout(render, 100);
  });
</script>

{% schema %}
{
  "name": "GoPure Stylized Reviews",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "CUSTOMERS"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subheading",
      "default": "can't get enough"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Section Background",
      "default": "#f3f0ff"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card Background",
      "default": "#fff5f7"
    },
    {
      "type": "color",
      "id": "badge_bg_color",
      "label": "Pill Label Color",
      "default": "#e0d7ff"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text/Heading Color",
      "default": "#4834d4"
    },
    {
      "type": "header",
      "content": "Footer"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button Label",
      "default": "See All Reviews"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button Link"
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Review",
      "settings": [
        {
            "type": "image_picker",
            "id": "image_before",
            "label": "Before Image"
        },
        {
            "type": "image_picker",
            "id": "image_after",
            "label": "After Image"
        },
        {
            "type": "text",
            "id": "duration",
            "label": "Duration Label",
            "default": "8 Weeks"
        },
        {
            "type": "textarea",
            "id": "quote",
            "label": "Review Quote",
            "default": "The glow is actually insane."
        },
        {
            "type": "image_picker",
            "id": "author_image",
            "label": "Author Photo"
        },
        {
            "type": "text",
            "id": "author_name",
            "label": "Author Name",
            "default": "Sarah J."
        },
        {
            "type": "text",
            "id": "concern",
            "label": "Author Title/Concern",
            "default": "Dullness"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "GoPure Stylized Reviews",
      "blocks": [
        { "type": "review" },
        { "type": "review" },
        { "type": "review" }
      ]
    }
  ]
}
{% endschema %}
